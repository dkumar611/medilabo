<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Patients List</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
</head>

<body class="bg-light">

<div class="container mt-4">
    <h2 class="text-center mb-4">Patient Directory</h2>

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
            + Add Patient
        </button>
    </div>

    <!-- Patients Table -->
    <table class="table table-striped table-bordered shadow-sm">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>First</th>
            <th>Last</th>
            <th>DOB</th>
            <th>Gender</th>
            <th>Phone</th>
            <th>Triggers</th>
            <th>Risk</th>
            <th style="width:260px;">Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="p : ${patients}">
            <td th:text="${p.id}"></td>
            <td th:text="${p.firstName}"></td>
            <td th:text="${p.lastName}"></td>
            <td th:text="${p.dateOfBirth}"></td>
            <td th:text="${p.gender}"></td>
            <td th:text="${p.phone}"></td>

            <!-- Trigger count -->
            <td th:text="${p.triggerTermCount} ?: 0"></td>

            <!-- Risk badge -->
            <td>
        <span th:text="${p.riskLevel}"
              th:classappend="
                  ${p.riskLevel} == 'None' ? 'badge bg-success' :
                  (${p.riskLevel} == 'Borderline' ? 'badge bg-warning' :
                  (${p.riskLevel} == 'In Danger' ? 'badge bg-danger' :
                  'badge bg-dark'))">
        </span>
            </td>

            <td class="text-nowrap">
                <!-- View Notes Page -->
                <a th:href="@{'/patients/' + ${p.id} + '/notes'}"
                   class="btn btn-sm btn-info">
                    Notes
                </a>

                <!-- Add Note Modal -->
                <button class="btn btn-sm btn-success"
                        data-bs-toggle="modal"
                        data-bs-target="#noteModal"
                        th:attr="data-patientid=${p.id}">
                    + Note
                </button>

                <!-- Edit/Delete -->
                <a th:href="@{'/patients/edit/' + ${p.id}}"
                   class="btn btn-sm btn-warning">Edit</a>

                <a th:href="@{'/patients/delete/' + ${p.id}}"
                   class="btn btn-sm btn-danger"
                   onclick="return confirm('Delete this patient?');">Delete</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- ================= ADD PATIENT MODAL ================= -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form th:action="@{/patients}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Patient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body row g-2">
                    <div class="col-md-6">
                        <label class="form-label">First Name</label>
                        <input class="form-control" name="firstName" required/>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Last Name</label>
                        <input class="form-control" name="lastName" required/>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">DOB</label>
                        <input type="date" class="form-control" name="dateOfBirth" required/>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Gender</label>
                        <input class="form-control" name="gender"/>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Address</label>
                        <input class="form-control" name="address"/>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Phone</label>
                        <input class="form-control" name="phone"/>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Patient</button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- ================= ADD NOTE MODAL ================= -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Form posts to NotesViewController dynamically -->
            <form method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Add Medical Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <!-- Hidden patientId set by JS -->
                    <input type="hidden" name="patientId" id="notePatientId"/>

                    <div class="mb-2">
                        <label class="form-label">Physician</label>
                        <input class="form-control" name="physician" required/>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" name="note" rows="6" required></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Note</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const noteModal = document.getElementById('noteModal');
    noteModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const patientId = button.getAttribute('data-patientid');

        // Set hidden input
        document.getElementById('notePatientId').value = patientId;

        // Dynamically set form action
        const form = noteModal.querySelector('form');
        form.action = `/patients/${patientId}/notes`;
    });
</script>

</body>
</html>
